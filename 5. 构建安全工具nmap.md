## 工具调用与编排编写

在 潮汐平台，所有的工程项目分为两种

* 自用工具包
* 供外部调用的工具包或者编排

在上一步的 helloworld 项目中，项目初始化之后创建文件就可以开始代码工作，这种即为自用工具包，您可以自由决定和创建项目的目录结构，**如果您想让包供他人使用，外部调用，则必须按照潮汐平台的规则建立规范的项目结构**：

```bash
<username>.<tool>/lev/<username>/<tool>
```



工具调用与编排编写需要先配置好前置的依赖环境，如果没有完成以上步骤，请阅读[环境配置](#开发环境配置)板块，同时也需要各种接入潮汐系统的支持，请阅读[凭证上传与获取](#凭证上传与获取)模块，之后便可进行工作区的搭建，进行工具调用与编排编写。

* 工具调用：对封装有完整工具的 Docker 镜像启用，并将设定的参数与所要执行的命令传入镜像，通过定义的方法，对得到的结果进行处理并保存到 mongodb 的程序（Docker 使用[详见此处](https://docs.docker.com/get-started/)）。
* 编排编写：决定工具将如何使用（如运行在何种模式，传入哪些参数命令）及得到的数据将如何传递运用的函数编写。

nmap 作为安全行业无人不知的端口扫描工具，下面将使用 nmap 作为示例，搭建出一个工具包。

此项目中分别有三个 python 文件：

* \__init__.py				    初始化文件，负责模块的导入
* asset.py                       编排文件，负责模块的编排
* nmap_python.py       模块具体模式或者实现功能代码



### 工具包搭建

1. 先在本地创建工作区目录，如 `./nmap_python`；

   ```bash
   $ mkdir nmap_python
   ```



2. 进入`./nmap_python`，执行配置文件安装命令，levhub-key 的获取详情请见[SDK凭证获取](#sdk凭证获取)：

   ```bash
   $ cd nmap_python
   # 配置接入潮汐系统 SDK 的凭证 levhub-key 作为全局变量，建议放入系统配置文件中，否则会在重新打开终端之后消失，每次构建新的工程项目时都需要重新导入
   $ export LEVHUB_KEY=your levhub-key

   # lev 可以替换为自己社区用户名称，nmap_python 为将要上传的工具名
   $ pdm lev new szczecin.nmap_python
   $ cd ./szczecin.nmap_python

   #./lev-hub/username.tool 目录下安装 levrt 包
   $ pdm add levrt
   ```



* 在`szczecin.nmap_python`目录下得到配置文件`.pdm.toml`、`pyproject.toml`及 levrt 依赖 包 `__pypackages__`；

* 然后需要在 `szczecin.nmap_python` 目录下手动创建目录

  ```bash
  $ mkdir lev
  $ mkdir lev/szczecin
  $ mkdir lev/szczecin/nmap_python
  ```


3. 最终工具包目录结构如下，部分文件需要手动创建：

```shell
./lev-hub/
└── szczecin.nmap_python/
    ├── .gitignore
    ├── lev/						# 手动创建，供外部调用的项目必须有此目录结构，且必须命名为lev
    │   └── szczecin/				# 手动创建，供外部调用的项目必须有此目录结构，潮汐平台用户名
    │       └── nmap_python/		# 手动创建，供外部调用的项目必须有此目录结构，工具名
    │           ├── asset.py		# 手动创建，编排文件，负责模块的编排
    │           ├── nmap_python.py	# 手动创建，就是上面描述中的 tool.py，模块具体模式或者实现功能代码
    │           └── __init__.py		# 手动创建，初始化文件，负责模块的导入
    ├── pdm.lock						
    ├── .pdm.toml
    ├── __package__					# python相关依赖包存放的文件夹
    └── pyproject.toml
  ...
```







### 工具基础调用

上面基础的包结构我们已经介绍完毕，这里介绍包内文件说明，一个完整的项目最少包含下面一个文件，`__init__.py`：

* `__init__.py`            # 必要文件
* `asset.py`               # 非必要文件
* `tool.py`                # 非必要文件，名称不顾定，通常以工具名命名，例如 nmap.py

首先从 tool.py 开始介绍，以最简单的无模式调用 nmap 为例：

#### tool.py 介绍

tool.py 并不是一个固定的名称，它泛指所有的封装了工具调用函数的python文件

##### 无模式调用

所谓的 无模式调用，即 工具调用文件中，只封装了一条命令，只有一个函数

请**严格按照下列代码格式，不要省略部分注释或者参数**，防止调用失败

以下以上传 nmap_python 工具举例：

1. 在编写`nmap_python.py`文件前，首先阅读`镜像管理`的相关内容，将要调用的工具镜像的构建文件 Dockerfile 上传到绑定好的 Github 仓库，用于潮汐开源社区平台自动构建镜像，得到镜像名称与版本号（.username.tool:tag），如 `.szczecin.nmap_python:v1.0`；

2. 开始编写`nmap_python.py`

   此处示例，将 nmap 的一条命令封装为无模式工具，命令如下

   `nmap -sS -Pn -p- -T4 --open -O -oX /tmp/port_os.xml ip`

   代码开始部分写入工具的简要概述 [(注2)](#为何要在工具和编排内写好一系列注释？不写可以吗？)

   概述包含工具的简介、名称（desc）与[工具类型（cats）](#附录：工具分类中英对照一览)等都利用修饰器写在函数前，将 nmap_python 定义为一个完整的函数模式

   **以下代码中 # 之后的内容皆为代码说明，不可直接仿照形式写入或者复制粘贴到代码文件中**：

   ~~~python
   # 以下内容为工具简介，不可省略
   """
   nmap是一个用于网络发现和安全审计的免费开源程序，用于网络扫描、服务升级计划管理以及主机或服务正常运行时间监控等任务，
   通过使用原始IP数据包来确定网络上可用的主机、这些主机提供的服务（应用程序名称和版本）、它们运行的操作系统信息、数据包过滤器/防火墙的类型等信息。
   nmap_python 镜像包含 nmap 实时更新的二进制版本，并搭配有 python 环境，对 nmap-os-db文件实时更新。
   """
   #导入工具依赖包，分别用于启动工具镜像、将结果数据写入数据库、改写 ENTRYPOINT 和解析注释
   from levrt import Cr, ctx, remote, annot
   from levrt.annot.cats import Attck, BlackArch

   #利用 annot 修饰器，对 此方法 和 params（参数）进行介绍与举例
   # holder 为 参数 ip 的示例
   @annot.meta(desc="nmap SYN扫描目标主机开放端口、主机名及操作系统", params=[annot.Param("ip", "进行扫描的目标ip或ip段", holder="192.168.1.1/24")])
   def port_os(ip: str) -> Cr: # 注意定义模式时需要指明各参数的参数类型，如此处的 cli 为 list（数组）
       """
       nmap SYN扫描目标主机开放端口、主机名及操作系统（模式说明，必须要有，不可省略）
       ```
       await nmap_python.port_os("192.168.1.1/24")(调用示例,不可省略)
       ```
       """
       @remote
       def entry(ip):
           import subprocess
           import sys
           sys.path.append("/usr/lib/python3.9/site-packages")
           # 执行命令
           subprocess.run(['nmap', '-sS', '-Pn', '-p-', '-T4', '--open', '-O', '-oX', '/tmp/port_os.xml', ip])
           # 此处省略 结果数据处理代码
           ctx.update(result) # 存入 mongo 数据库中
       return Cr("registry.cn-hangzhou.aliyuncs.com/levkit/nmap_python:v1.0", "szczecin/nmap_python.port_os@1.0", entry=entry(ip), host=True)
   ~~~

    代码中  entry( ) 方法将覆盖掉原工具镜像容器构建时，在 Dockerfile 中使用的 ENTRYPOINT [ ] [(注4)](#entry()将覆盖ENTRYPOINT[]？)
    
    用户可以在 entry( )  方法中指定工具镜像接收到参数后该如何执行命令，以及如何处理传出结果数据 [(注5)](#工具输出的结果数据将被如何处理？)：

     最后，raw 模式返回时，将会利用 Cr( ) 方法启用`.szczecin.nmap_python:v1.0`镜像，并在容器中执行 entry( ) 方法定义的命令和输出处理，最后把数据传入 mongodb 的 `szczecin/nmap_python@1.0` 空间[(注6)](#如何指定工具输出结果的存储位置？)：



3. 此时一个 无模式调用 的工具就完成了，整个 tool.py (即 nmap_python.py )文件中只有一个 port_os() 函数，所以叫做无模式

4. 上面代码中不可缺少的注释，在审核完毕可以公开调用的时候，会出现在潮汐平台上如下位置：

   ![](C:\Users\alex\Desktop\截图\潮汐文档\代码注释作用.png)

5. `@annot.meta` 参数说明如下：

   | 参数名       | 参数类型    | 参数说明       | 参数示例                                                     |
   | ------------ | ----------- | -------------- | ------------------------------------------------------------ |
   | desc         | str         | 模式(方法)说明 | "nmap SYN扫描目标主机开放端口、主机名及操作系统"             |
   | params       | annot.Param | 模式调用参数   | annot.Param("ip", "进行扫描的目标ip或ip段", holder="192.168.1.1/24") |
   | Param.holder | str         | 参数示例       | ”192.168.1.1/24"                                             |
